#!/usr/bin/env python

import re
import requests
import time


bz_resolution_map = {
    "CONFIRMED": [
        926, 1021, 1981, 2140, 2251, 2505, 2587, 2588, 2606, 2633, 2646, 2650, 2663, 2695, 2696, 2705, 2764, 2814, 2820, 2834,
        2873, 2879, 2882, 2906, 2983, 3098, 3155, 3187, 3308, 3470, 3637, 3679, 3725, 3871, 3891, 3920, 4068, 4083, 4248, 4261,
        4312, 4385, 4519, 4683, 4979, 5141, 5174, 5374, 5779, 5780, 5932, 5976, 6011, 6801, 6809, 7871, 7873, 8104, 8233, 9289,
        9332, 9430, 9431, 9432, 9433, 9465, 9636, 9874, 9930, 10498, 10612, 10915, 10916, 10966, 11197, 11317, 11388, 11505, 12187, 12324,
        12639, 12830, 12985, 13021, 13079, 13266, 13541, 13653, 13715, 13807, 13875, 14030, 14081, 14113, 14335, 14429, 15190, 15730, 16193, 17064,
        17130, 17164, 17190, 17267, 17456, 17782, 17814, 17942, 17951, 18327, 18407, 18455, 18594, 18828, 18990, 19056, 19076, 19125, 19128, 19189,
        19328, 19611, 19687, 19708, 19853, 19864, 19970, 20220, 20397, 20514, 20596, 20670, 20765, 20773, 20819, 20831, 20858, 20871, 20885, 20946,
        20973, 21016, 21052, 21134, 21229, 21283, 21370, 21420, 21530, 21627, 21634, 21642, 21826, 21895, 21950, 21975, 21983, 22007, 22066, 22116,
        22177, 22180, 22186, 22221, 22239, 22385, 22619, 22634, 22657, 22762, 22801, 22839, 22880, 22882, 22886, 22927, 23090, 23169, 23174, 23317,
        23341, 23384, 23416, 23505, 23628, 23692, 23728, 23735, 23857, 24086, 24340, 24347, 24424, 24451, 24474, 24604, 24616, 24639, 24692, 24761,
        24817, 25084, 25132, 25165, 25176, 25329, 25352, 25378, 25436, 25627, 25685, 25705, 25736, 25739, 25836, 25888, 25924, 26055, 26077, 26083,
        26092, 26216, 26234, 26246, 26380, 26384, 26400, 26634, 26662, 26766, 26945, 27034, 27042, 27093, 27205, 27299, 27353, 27404, 27425, 27438,
        27458, 27573, 27658, 27663, 27732, 27846, 27947, 27992, 28022, 28032, 28092, 28147, 28285, 28450, 28471, 28500, 28527, 28566, 28601, 28680,
        28743, 28809, 28909, 30234, 30299, 30335, 30391, 30392, 30426, 30516, 30572, 30601, 30662, 30664, 30669, 30701, 30729, 30787, 30817, 30898,
        31032, 31042, 31084, 31131, 31155, 31161, 31268, 31365, 31392, 31544, 31572, 31612, 31677, 31792, 31800, 31807, 31858, 31924, 31940, 32086,
        32140, 32159, 32165, 32166, 32208, 32294, 32428, 32435, 32442, 32466, 32609, 32802, 32856, 33125, 33258, 33297, 33486, 33489, 33494, 33516,
        33547, 33594, 33642, 33655, 33731, 33767, 33808, 33915, 33988, 34002, 34005, 34173, 34401, 34435, 34488, 34609, 34647, 34753, 34760, 34769,
        34815, 34893, 34897, 34944, 35086, 35203, 35249, 35278, 35304, 35350, 35384, 35470, 35587, 35595, 35602, 35657, 35835, 35990, 36001, 36046,
        36100, 36137, 36243, 36286, 36429, 36471, 36478, 36481, 36492, 36612, 36831, 36852, 36880, 36885, 36913, 36916, 36978, 37014, 37136, 37187,
        37290, 37532, 37558, 37599, 37637, 38010, 38014, 38205, 38314, 38341, 38388, 38409, 38449, 38471, 38498, 38599, 38692, 38732, 38832, 38894,
        38980, 38997, 39062, 39152, 39175, 39206, 39208, 39236, 39239, 39257, 39311, 39326, 39390, 39396, 39430, 39447, 39448, 39489, 39498, 39499,
        39599, 39633, 39634, 39654, 39656, 39658, 39690, 39716, 39721, 39755, 39760, 39787, 39788, 39854, 39856, 39858, 39866, 39881, 39891, 39902,
        39906, 39939, 39943, 39972, 39974, 40024, 40036, 40040, 40044, 40088, 40092, 40107, 40145, 40174, 40188, 40200, 40226, 40235, 40287, 40342,
        40347, 40378, 40396, 40418, 40458, 40484, 40552, 40580, 40598, 40599, 40613, 40636, 40652, 40701, 40718, 40791, 40815, 40816, 40824, 40836,
        40913, 40976, 41018, 41025, 41082, 41086, 41104, 41115, 41119, 41123, 41159, 41169, 41227, 41284, 41320, 41324, 41452, 41480, 41482, 41534,
        41540, 41559, 41561, 41575, 41687, 41752, 41766, 41783, 41809, 41922, 41957, 42014, 42028, 42049, 42053, 42077, 42148, 42221, 42226, 42243,
        42252, 42254, 42263, 42275, 42304, 42322, 42365, 42398, 42406, 42415, 42431, 42433, 42476, 42480, 42508, 42539, 42573, 42591, 42594, 42601,
        42626, 42655, 42710, 42734, 42758, 42780, 42784, 42811, 42816, 42851, 42915, 42920, 42925, 42938, 42955, 42975, 43002, 43042, 43053, 43076,
        43080, 43086, 43096, 43120, 43135, 43144, 43151, 43202, 43221, 43263, 43264, 43274, 43304, 43307, 43364, 43382, 43459, 43506, 43517, 43598,
        43673, 43682, 43693, 43702, 43738, 43740, 43768, 43770, 43782, 43788, 43811, 43854, 43906, 43920, 43949, 43955, 43965, 43970, 43980, 44036,
        44053, 44063, 44114, 44123, 44155, 44204, 44206, 44207, 44241, 44251, 44259, 44263, 44267, 44352, 44374, 44400, 44455, 44479, 44483, 44492,
        44537, 44616, 44636, 44651, 44748, 44750, 44775, 44836, 44843, 44871, 44918, 44947, 44951, 44963, 45021, 45111, 45120, 45121, 45134, 45136,
        45141, 45143, 45145, 45148, 45153, 45198, 45234, 45242, 45280, 45292, 45308, 45331, 45353, 45472, 45475, 45498, 45507, 45524, 45532, 45551,
        45554, 45555, 45571, 45595, 45599, 45654, 45667, 45676, 45678, 45735, 45739, 45740, 45766, 45786, 45821, 45837, 45845, 45846, 45850, 45869,
        45879, 45883, 45902, 45915, 45920, 45934, 45962, 45964, 45971, 45992, 45994, 46009, 46016, 46026, 46074, 46087, 46099, 46104, 46140, 46167,
        46190, 46196, 46199, 46215, 46216, 46243, 46346, 46376, 46391, 46394, 46410, 46425, 46426, 46428, 46446, 46463, 46507, 46529, 46554, 46555,
        46557, 46566, 46684, 46692, 46711, 46853, 46947, 46991, 47002, 47016, 47039, 47054, 47093, 47113, 47116, 47202, 47204, 47239, 47243, 47257,
        47273, 47345, 47358, 47369, 47386, 47395, 47411, 47419, 47449, 47461, 47474, 47497, 47514, 47522, 47524, 47527, 47531, 47548, 47559, 47722,
        47727, 47752, 47786, 47792, 47836, 47845, 47877, 47926, 47940, 48026, 48027, 48032, 48067, 48081, 48104, 48116, 48121, 48144, 48145, 48173,
        48226, 48250, 48299, 48308, 48311, 48330, 48356, 48358, 48397, 48410, 48474, 48475, 48482, 48489, 48516, 48525, 48534, 48535, 48537, 48539,
        48541, 48558, 48576, 48588, 48653, 48659, 48671, 48696, 48701, 48729, 48730, 48739, 48745, 48771, 48794, 48797, 48839, 48863, 48886, 48968,
        48975, 49012, 49018, 49076, 49081, 49084, 49101, 49143, 49312, 49321, 49324, 49344, 49442, 49520, 49544, 49546, 49564, 49580, 49585, 49595,
        49618, 49626, 49627, 49633, 49671, 49676, 49719, 49722, 49727, 49735, 49737, 49749, 49756, 49759, 49765, 49767, 49769, 49792, 49808, 49816,
        49834, 49842, 49853, 49860, 49877, 49933, 49940, 49948, 49960, 49973, 49975, 49978, 49986, 49995, 50005, 50008, 50052, 50072, 50157, 50162,
        50192, 50272, 50286, 50316, 50329, 50345, 50347, 50359, 50361, 50450, 50495, 50513, 50532, 50544, 50551, 50613, 50711, 50736, 50739, 50750,
        50754, 50771, 50796, 50798, 50803, 50807, 50814, 50823, 50841, 50931, 51006, 51032, 51036, 51043, 51093, 51115, 51150, 51158, 51181, 51279,
        51320, 51451, 51485, 51489, 51503, 51512, 51527, 51537, 51559, 51590, 51709, 51710, 51756, 51788, 51818, 51832, 51879, 51881, 51892, 51919,
        51927, 51935, 52005, 52013, 52047, 52072, 52109, 52112, 52119, 52120, 52169, 52223, 52224, 52228, 52229, 52251, 52252, 52275, 52281, 52289,
        52299, 52308, 52353, 52392, 52402, 52422, 52466, 52468, 52517, 52527, 52552, 52553, 52561, 52595,
    ],
}


if __name__ == '__main__':
    gh_resolution_map = {}
    start_time = time.time()
    total = sum(len(ids) for ids in bz_resolution_map.values())
    processed = 0
    for key, bz_ids in bz_resolution_map.items():
        gh_ids = []
        for bz_id in bz_ids:
            r = requests.get(
                'https://llvm.org/PR%d' % bz_id,
                allow_redirects=False,
            )
            assert r.status_code == 301
            archive_url = r.headers['Location']
            m = re.match(r'https://github.com/llvm/llvm-bugzilla-archive/issues/(\d+)', archive_url)
            assert m
            r = requests.get(
                archive_url,
                allow_redirects=False,
            )
            assert r.status_code == 302
            gh_url = r.headers['Location']
            m = re.match(r'https://github.com/llvm/llvm-project/issues/(\d+)', gh_url)
            assert m
            gh_id = m.group(1)
            gh_ids.append(gh_id)

            processed += 1
            elapsed = time.time() - start_time
            remaining = elapsed * (total - processed) / processed
            print('Processed %d of %d bugs in %.2fs; %ds remaining' % (processed, total, elapsed, remaining))

        gh_resolution_map[key] = gh_ids

        # This is accidentally misindented by one level, but the accident
        # turned out to produce helpful intermediate results, so I'm keeping it.

        print('\n\ngh_resolution_map = {')
        for key in gh_resolution_map.keys():
            print('    "%s": [' % key, end='')
            for i, gh_id in enumerate(gh_resolution_map[key]):
                if i % 20 == 0:
                    print('\n       ', end='')
                print(' %s,' % gh_id, end='')
            print('\n    ],')
        print('}')
